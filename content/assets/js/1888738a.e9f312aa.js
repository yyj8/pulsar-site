"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[42719],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>k});var a=r(67294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function o(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},l=Object.keys(e);for(a=0;a<l.length;a++)r=l[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)r=l[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var s=a.createContext({}),u=function(e){var t=a.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,l=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=u(r),m=n,k=p["".concat(s,".").concat(m)]||p[m]||d[m]||l;return r?a.createElement(k,i(i({ref:t},c),{},{components:r})):a.createElement(k,i({ref:t},c))}));function k(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=r.length,i=new Array(l);i[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[p]="string"==typeof e?e:n,i[1]=o;for(var u=2;u<l;u++)i[u]=r[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,r)}m.displayName="MDXCreateElement"},85162:(e,t,r)=>{r.d(t,{Z:()=>i});var a=r(67294),n=r(86010);const l={tabItem:"tabItem_Ymn6"};function i(e){let{children:t,hidden:r,className:i}=e;return a.createElement("div",{role:"tabpanel",className:(0,n.Z)(l.tabItem,i),hidden:r},t)}},65488:(e,t,r)=>{r.d(t,{Z:()=>d});var a=r(87462),n=r(67294),l=r(86010),i=r(72389),o=r(67392),s=r(7094),u=r(12466);const c={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function p(e){const{lazy:t,block:r,defaultValue:i,values:p,groupId:d,className:m}=e,k=n.Children.map(e.children,(e=>{if((0,n.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),h=p??k.map((e=>{let{props:{value:t,label:r,attributes:a}}=e;return{value:t,label:r,attributes:a}})),v=(0,o.l)(h,((e,t)=>e.value===t.value));if(v.length>0)throw new Error(`Docusaurus error: Duplicate values "${v.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const f=null===i?i:i??k.find((e=>e.props.default))?.props.value??k[0].props.value;if(null!==f&&!h.some((e=>e.value===f)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${f}" but none of its children has the corresponding value. Available values are: ${h.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:b,setTabGroupChoices:N}=(0,s.U)(),[g,y]=(0,n.useState)(f),C=[],{blockElementScrollPositionUntilNextRender:w}=(0,u.o5)();if(null!=d){const e=b[d];null!=e&&e!==g&&h.some((t=>t.value===e))&&y(e)}const P=e=>{const t=e.currentTarget,r=C.indexOf(t),a=h[r].value;a!==g&&(w(t),y(a),null!=d&&N(d,String(a)))},T=e=>{let t=null;switch(e.key){case"Enter":P(e);break;case"ArrowRight":{const r=C.indexOf(e.currentTarget)+1;t=C[r]??C[0];break}case"ArrowLeft":{const r=C.indexOf(e.currentTarget)-1;t=C[r]??C[C.length-1];break}}t?.focus()};return n.createElement("div",{className:(0,l.Z)("tabs-container",c.tabList)},n.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.Z)("tabs",{"tabs--block":r},m)},h.map((e=>{let{value:t,label:r,attributes:i}=e;return n.createElement("li",(0,a.Z)({role:"tab",tabIndex:g===t?0:-1,"aria-selected":g===t,key:t,ref:e=>C.push(e),onKeyDown:T,onClick:P},i,{className:(0,l.Z)("tabs__item",c.tabItem,i?.className,{"tabs__item--active":g===t})}),r??t)}))),t?(0,n.cloneElement)(k.filter((e=>e.props.value===g))[0],{className:"margin-top--md"}):n.createElement("div",{className:"margin-top--md"},k.map(((e,t)=>(0,n.cloneElement)(e,{key:t,hidden:e.props.value!==g})))))}function d(e){const t=(0,i.Z)();return n.createElement(p,(0,a.Z)({key:String(t)},e))}},55026:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>u});var a=r(87462),n=(r(67294),r(3905));r(65488),r(85162);const l={id:"client-libraries-cluster-level-failover",title:"Configure cluster-level failover",sidebar_label:"Configure cluster-level failover"},i=void 0,o={unversionedId:"client-libraries-cluster-level-failover",id:"client-libraries-cluster-level-failover",title:"Configure cluster-level failover",description:"For more information about cluster-level failover, including concepts, benefits, use cases, constraints, usage and working principles, see Cluster-level failover concepts.",source:"@site/docs/client-libraries-cluster-level-failover.md",sourceDirName:".",slug:"/client-libraries-cluster-level-failover",permalink:"/docs/next/client-libraries-cluster-level-failover",draft:!1,editUrl:"https://github.com/apache/pulsar-site/edit/main/docs/client-libraries-cluster-level-failover.md",tags:[],version:"current",frontMatter:{id:"client-libraries-cluster-level-failover",title:"Configure cluster-level failover",sidebar_label:"Configure cluster-level failover"},sidebar:"docsSidebar",previous:{title:"Work with schema",permalink:"/docs/next/client-libraries-schema"},next:{title:"Java client",permalink:"/docs/next/client-libraries-java-configs"}},s={},u=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Configure cluster-level failover",id:"configure-cluster-level-failover",level:2},{value:"Automatic failover",id:"automatic-failover",level:3},{value:"Controlled failover",id:"controlled-failover",level:3}],c={toc:u},p="wrapper";function d(e){let{components:t,...l}=e;return(0,n.kt)(p,(0,a.Z)({},c,l,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"For more information about cluster-level failover, including concepts, benefits, use cases, constraints, usage and working principles, see ",(0,n.kt)("a",{parentName:"p",href:"/docs/next/concepts-cluster-level-failover"},"Cluster-level failover concepts"),". "),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("ul",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"You should configure cluster-level failover only when the cluster contains sufficient resources to handle all possible consequences. Workload intensity on the backup cluster may increase significantly.")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Connect your clusters to an uninterruptible power supply (UPS) unit to reduce the risk of unexpected power loss.")))),(0,n.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Pulsar Java client 2.10 or later versions."),(0,n.kt)("li",{parentName:"ul"},"For backup clusters:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"The number of BookKeeper nodes should be equal to or greater than the ensemble quorum."),(0,n.kt)("li",{parentName:"ul"},"The number of ZooKeeper nodes should be equal to or greater than 3."))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Turn on geo-replication")," between the primary cluster and any dependent cluster (primary to backup or backup to backup) to prevent data loss."),(0,n.kt)("li",{parentName:"ul"},"Set ",(0,n.kt)("inlineCode",{parentName:"li"},"replicateSubscriptionState")," to ",(0,n.kt)("inlineCode",{parentName:"li"},"true")," when creating consumers.")),(0,n.kt)("h2",{id:"configure-cluster-level-failover"},"Configure cluster-level failover"),(0,n.kt)("h3",{id:"automatic-failover"},"Automatic failover"),(0,n.kt)("p",null,"This is an example of how to construct a Java Pulsar client to use automatic cluster-level failover. The switchover is triggered automatically."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'private PulsarClient getAutoFailoverClient() throws PulsarClientException {\n    String primaryUrl = "pulsar+ssl://localhost:6651";\n    String secondaryUrl = "pulsar+ssl://localhost:6661";\n    String secondaryTlsTrustCertsFilePath = "secondary/path";\n    Authentication secondaryAuthentication = AuthenticationFactory.create(\n        "org.apache.pulsar.client.impl.auth.AuthenticationTls",\n        "tlsCertFile:/path/to/secondary-my-role.cert.pem,"\n                + "tlsKeyFile:/path/to/secondary-role.key-pk8.pem");\n                \n    // You can put more failover cluster config in to map\n    Map<String, String> secondaryTlsTrustCertsFilePaths = new HashMap<>();\n    secondaryTlsTrustCertsFilePaths.put(secondaryUrl, secondaryTlsTrustCertsFilePath);\n    Map<String, Authentication> secondaryAuthentications = new HashMap<>();\n    secondaryAuthentications.put(secondaryUrl, secondaryAuthentication);\n    ServiceUrlProvider failover = AutoClusterFailover.builder()\n        .primary(primaryUrl)\n        .secondary(List.of(secondaryUrl))\n        .failoverDelay(30, TimeUnit.SECONDS)\n        .switchBackDelay(60, TimeUnit.SECONDS)\n        .checkInterval(1000, TimeUnit.MILLISECONDS)\n        .secondaryTlsTrustCertsFilePath(secondaryTlsTrustCertsFilePaths)\n        .secondaryAuthentication(secondaryAuthentications)\n        .build();\n\n    PulsarClient pulsarClient = PulsarClient.builder()\n        .build();\n\n    failover.initialize(pulsarClient);\n    return pulsarClient;\n}\n')),(0,n.kt)("p",null,"Configure the following parameters:"),(0,n.kt)("table",null,(0,n.kt)("thead",{parentName:"table"},(0,n.kt)("tr",{parentName:"thead"},(0,n.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,n.kt)("th",{parentName:"tr",align:null},"Default value"),(0,n.kt)("th",{parentName:"tr",align:null},"Required?"),(0,n.kt)("th",{parentName:"tr",align:null},"Description"))),(0,n.kt)("tbody",{parentName:"table"},(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"primary")),(0,n.kt)("td",{parentName:"tr",align:null},"N/A"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"Service URL of the primary cluster.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"secondary")),(0,n.kt)("td",{parentName:"tr",align:null},"N/A"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"Service URL(s) of one or several backup clusters.",(0,n.kt)("br",null),(0,n.kt)("br",null),"You can specify several backup clusters using a comma-separated list.",(0,n.kt)("br",null),(0,n.kt)("br",null)," Note that:",(0,n.kt)("br",null),"- The backup cluster is chosen in the sequence shown in the list. ",(0,n.kt)("br",null),"- If all backup clusters are available, the Pulsar client chooses the first backup cluster.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"failoverDelay")),(0,n.kt)("td",{parentName:"tr",align:null},"N/A"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"The delay before the Pulsar client switches from the primary cluster to the backup cluster.",(0,n.kt)("br",null),(0,n.kt)("br",null),"Automatic failover is controlled by a probe task: ",(0,n.kt)("br",null),"1) The probe task first checks the health status of the primary cluster. ",(0,n.kt)("br",null)," 2) If the probe task finds the continuous failure time of the primary cluster exceeds ",(0,n.kt)("inlineCode",{parentName:"td"},"failoverDelayMs"),", it switches the Pulsar client to the backup cluster.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"switchBackDelay")),(0,n.kt)("td",{parentName:"tr",align:null},"N/A"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"The delay before the Pulsar client switches from the backup cluster to the primary cluster.",(0,n.kt)("br",null),(0,n.kt)("br",null),"Automatic failover switchover is controlled by a probe task: ",(0,n.kt)("br",null)," 1) After the Pulsar client switches from the primary cluster to the backup cluster, the probe task continues to check the status of the primary cluster. ",(0,n.kt)("br",null)," 2) If the primary cluster functions well and continuously remains active longer than ",(0,n.kt)("inlineCode",{parentName:"td"},"switchBackDelay"),", the Pulsar client switches back to the primary cluster.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"checkInterval")),(0,n.kt)("td",{parentName:"tr",align:null},"30s"),(0,n.kt)("td",{parentName:"tr",align:null},"No"),(0,n.kt)("td",{parentName:"tr",align:null},"Frequency of performing a probe task (in seconds).")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"secondaryTlsTrustCertsFilePath")),(0,n.kt)("td",{parentName:"tr",align:null},"N/A"),(0,n.kt)("td",{parentName:"tr",align:null},"No"),(0,n.kt)("td",{parentName:"tr",align:null},"Path to the trusted TLS certificate file of the backup cluster.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"secondaryAuthentication")),(0,n.kt)("td",{parentName:"tr",align:null},"N/A"),(0,n.kt)("td",{parentName:"tr",align:null},"No"),(0,n.kt)("td",{parentName:"tr",align:null},"Authentication of the backup cluster.")))),(0,n.kt)("h3",{id:"controlled-failover"},"Controlled failover"),(0,n.kt)("p",null,"This is an example of how to construct a Java Pulsar client to use controlled cluster-level failover. The switchover is triggered by administrators manually."),(0,n.kt)("admonition",{type:"note"},(0,n.kt)("p",{parentName:"admonition"},"You can have one or several backup clusters but can only specify one.")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'public PulsarClient getControlledFailoverClient() throws IOException {\n    Map<String, String> header = new HashMap();\n    header.put("service_user_id", "my-user");\n    header.put("service_password", "tiger");\n    header.put("clusterA", "tokenA");\n    header.put("clusterB", "tokenB");\n\n    ServiceUrlProvider provider =\n            ControlledClusterFailover.builder()\n                    .defaultServiceUrl("pulsar://localhost:6650")\n                    .checkInterval(1, TimeUnit.MINUTES)\n                    .urlProvider("http://localhost:8080/test")\n                    .urlProviderHeader(header)\n                    .build();\n\n    PulsarClient pulsarClient =\n            PulsarClient.builder()\n                    .build();\n\n    provider.initialize(pulsarClient);\n    return pulsarClient;\n}\n')),(0,n.kt)("table",null,(0,n.kt)("thead",{parentName:"table"},(0,n.kt)("tr",{parentName:"thead"},(0,n.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,n.kt)("th",{parentName:"tr",align:null},"Default value"),(0,n.kt)("th",{parentName:"tr",align:null},"Required?"),(0,n.kt)("th",{parentName:"tr",align:null},"Description"))),(0,n.kt)("tbody",{parentName:"table"},(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"defaultServiceUrl")),(0,n.kt)("td",{parentName:"tr",align:null},"N/A"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"Pulsar service URL.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"checkInterval")),(0,n.kt)("td",{parentName:"tr",align:null},"30s"),(0,n.kt)("td",{parentName:"tr",align:null},"No"),(0,n.kt)("td",{parentName:"tr",align:null},"Frequency of performing a probe task (in seconds).")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"urlProvider")),(0,n.kt)("td",{parentName:"tr",align:null},"N/A"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"URL provider service.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"urlProviderHeader")),(0,n.kt)("td",{parentName:"tr",align:null},"N/A"),(0,n.kt)("td",{parentName:"tr",align:null},"No"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"urlProviderHeader")," is a map containing tokens and credentials. ",(0,n.kt)("br",null),(0,n.kt)("br",null),"If you enable authentication or authorization between Pulsar clients and primary and backup clusters, you need to provide ",(0,n.kt)("inlineCode",{parentName:"td"},"urlProviderHeader"),".")))),(0,n.kt)("p",null,"Here is an example of how ",(0,n.kt)("inlineCode",{parentName:"p"},"urlProviderHeader")," works."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"How urlProviderHeader works",src:r(713).Z,width:"1350",height:"680"})),(0,n.kt)("p",null,"Assume that you want to connect Pulsar client 1 to cluster A."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Pulsar client 1 sends the token ",(0,n.kt)("em",{parentName:"p"},"t1")," to the URL provider service.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"The URL provider service returns the credential ",(0,n.kt)("em",{parentName:"p"},"c1")," and the cluster A URL to the Pulsar client."),(0,n.kt)("p",{parentName:"li"},"The URL provider service manages all tokens and credentials. It returns different credentials based on different tokens and different target cluster URLs to different Pulsar clients."),(0,n.kt)("admonition",{parentName:"li",type:"note"},(0,n.kt)("p",{parentName:"admonition"},"The credential must be in a JSON file and contain parameters as shown.")),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-java"},'{\n"serviceUrl": "pulsar+ssl://target:6651", \n"tlsTrustCertsFilePath": "/security/ca.cert.pem",\n"authPluginClassName":"org.apache.pulsar.client.impl.auth.AuthenticationTls",\n"authParamsString": " \\"tlsCertFile\\": \\"/security/client.cert.pem\\" \n    \\"tlsKeyFile\\": \\"/security/client-pk8.pem\\" "\n}\n'))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Pulsar client 1 connects to cluster A using credential ",(0,n.kt)("em",{parentName:"p"},"c1"),"."))))}d.isMDXComponent=!0},713:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/cluster-level-failover-3-e4c1f0e86f1652f300f2bc54d342b955.png"}}]);